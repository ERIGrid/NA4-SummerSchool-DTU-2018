
% Default to the notebook output style

    


% Inherit from the specified cell style.




    
\documentclass[11pt]{article}

    
    
    \usepackage[T1]{fontenc}
    % Nicer default font (+ math font) than Computer Modern for most use cases
    \usepackage{mathpazo}

    % Basic figure setup, for now with no caption control since it's done
    % automatically by Pandoc (which extracts ![](path) syntax from Markdown).
    \usepackage{graphicx}
    % We will generate all images so they have a width \maxwidth. This means
    % that they will get their normal width if they fit onto the page, but
    % are scaled down if they would overflow the margins.
    \makeatletter
    \def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth
    \else\Gin@nat@width\fi}
    \makeatother
    \let\Oldincludegraphics\includegraphics
    % Set max figure width to be 80% of text width, for now hardcoded.
    \renewcommand{\includegraphics}[1]{\Oldincludegraphics[width=.8\maxwidth]{#1}}
    % Ensure that by default, figures have no caption (until we provide a
    % proper Figure object with a Caption API and a way to capture that
    % in the conversion process - todo).
    \usepackage{caption}
    \DeclareCaptionLabelFormat{nolabel}{}
    \captionsetup{labelformat=nolabel}

    \usepackage{adjustbox} % Used to constrain images to a maximum size 
    \usepackage{xcolor} % Allow colors to be defined
    \usepackage{enumerate} % Needed for markdown enumerations to work
    \usepackage{geometry} % Used to adjust the document margins
    \usepackage{amsmath} % Equations
    \usepackage{amssymb} % Equations
    \usepackage{textcomp} % defines textquotesingle
    % Hack from http://tex.stackexchange.com/a/47451/13684:
    \AtBeginDocument{%
        \def\PYZsq{\textquotesingle}% Upright quotes in Pygmentized code
    }
    \usepackage{upquote} % Upright quotes for verbatim code
    \usepackage{eurosym} % defines \euro
    \usepackage[mathletters]{ucs} % Extended unicode (utf-8) support
    \usepackage[utf8x]{inputenc} % Allow utf-8 characters in the tex document
    \usepackage{fancyvrb} % verbatim replacement that allows latex
    \usepackage{grffile} % extends the file name processing of package graphics 
                         % to support a larger range 
    % The hyperref package gives us a pdf with properly built
    % internal navigation ('pdf bookmarks' for the table of contents,
    % internal cross-reference links, web links for URLs, etc.)
    \usepackage{hyperref}
    \usepackage{longtable} % longtable support required by pandoc >1.10
    \usepackage{booktabs}  % table support for pandoc > 1.12.2
    \usepackage[inline]{enumitem} % IRkernel/repr support (it uses the enumerate* environment)
    \usepackage[normalem]{ulem} % ulem is needed to support strikethroughs (\sout)
                                % normalem makes italics be italics, not underlines
    

    
    
    % Colors for the hyperref package
    \definecolor{urlcolor}{rgb}{0,.145,.698}
    \definecolor{linkcolor}{rgb}{.71,0.21,0.01}
    \definecolor{citecolor}{rgb}{.12,.54,.11}

    % ANSI colors
    \definecolor{ansi-black}{HTML}{3E424D}
    \definecolor{ansi-black-intense}{HTML}{282C36}
    \definecolor{ansi-red}{HTML}{E75C58}
    \definecolor{ansi-red-intense}{HTML}{B22B31}
    \definecolor{ansi-green}{HTML}{00A250}
    \definecolor{ansi-green-intense}{HTML}{007427}
    \definecolor{ansi-yellow}{HTML}{DDB62B}
    \definecolor{ansi-yellow-intense}{HTML}{B27D12}
    \definecolor{ansi-blue}{HTML}{208FFB}
    \definecolor{ansi-blue-intense}{HTML}{0065CA}
    \definecolor{ansi-magenta}{HTML}{D160C4}
    \definecolor{ansi-magenta-intense}{HTML}{A03196}
    \definecolor{ansi-cyan}{HTML}{60C6C8}
    \definecolor{ansi-cyan-intense}{HTML}{258F8F}
    \definecolor{ansi-white}{HTML}{C5C1B4}
    \definecolor{ansi-white-intense}{HTML}{A1A6B2}

    % commands and environments needed by pandoc snippets
    % extracted from the output of `pandoc -s`
    \providecommand{\tightlist}{%
      \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
    % Add ',fontsize=\small' for more characters per line
    \newenvironment{Shaded}{}{}
    \newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
    \newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
    \newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
    \newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
    \newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
    \newcommand{\RegionMarkerTok}[1]{{#1}}
    \newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
    \newcommand{\NormalTok}[1]{{#1}}
    
    % Additional commands for more recent versions of Pandoc
    \newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
    \newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
    \newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
    \newcommand{\ImportTok}[1]{{#1}}
    \newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
    \newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
    \newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
    \newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
    \newcommand{\BuiltInTok}[1]{{#1}}
    \newcommand{\ExtensionTok}[1]{{#1}}
    \newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
    \newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
    \newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    \newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
    
    
    % Define a nice break command that doesn't care if a line doesn't already
    % exist.
    \def\br{\hspace*{\fill} \\* }
    % Math Jax compatability definitions
    \def\gt{>}
    \def\lt{<}
    % Document parameters
    \title{scenario\_build\_up}
    
    
    

    % Pygments definitions
    
\makeatletter
\def\PY@reset{\let\PY@it=\relax \let\PY@bf=\relax%
    \let\PY@ul=\relax \let\PY@tc=\relax%
    \let\PY@bc=\relax \let\PY@ff=\relax}
\def\PY@tok#1{\csname PY@tok@#1\endcsname}
\def\PY@toks#1+{\ifx\relax#1\empty\else%
    \PY@tok{#1}\expandafter\PY@toks\fi}
\def\PY@do#1{\PY@bc{\PY@tc{\PY@ul{%
    \PY@it{\PY@bf{\PY@ff{#1}}}}}}}
\def\PY#1#2{\PY@reset\PY@toks#1+\relax+\PY@do{#2}}

\expandafter\def\csname PY@tok@w\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.73,0.73}{##1}}}
\expandafter\def\csname PY@tok@c\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.74,0.48,0.00}{##1}}}
\expandafter\def\csname PY@tok@k\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.69,0.00,0.25}{##1}}}
\expandafter\def\csname PY@tok@o\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ow\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@nb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@nn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@ne\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.82,0.25,0.23}{##1}}}
\expandafter\def\csname PY@tok@nv\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@no\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@nl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@ni\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.60,0.60,0.60}{##1}}}
\expandafter\def\csname PY@tok@na\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.49,0.56,0.16}{##1}}}
\expandafter\def\csname PY@tok@nt\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@nd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.67,0.13,1.00}{##1}}}
\expandafter\def\csname PY@tok@s\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sd\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@si\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@se\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.13}{##1}}}
\expandafter\def\csname PY@tok@sr\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.40,0.53}{##1}}}
\expandafter\def\csname PY@tok@ss\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sx\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@m\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@gh\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gu\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.50,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@gd\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.63,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@gi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.63,0.00}{##1}}}
\expandafter\def\csname PY@tok@gr\endcsname{\def\PY@tc##1{\textcolor[rgb]{1.00,0.00,0.00}{##1}}}
\expandafter\def\csname PY@tok@ge\endcsname{\let\PY@it=\textit}
\expandafter\def\csname PY@tok@gs\endcsname{\let\PY@bf=\textbf}
\expandafter\def\csname PY@tok@gp\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,0.50}{##1}}}
\expandafter\def\csname PY@tok@go\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.53,0.53,0.53}{##1}}}
\expandafter\def\csname PY@tok@gt\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.27,0.87}{##1}}}
\expandafter\def\csname PY@tok@err\endcsname{\def\PY@bc##1{\setlength{\fboxsep}{0pt}\fcolorbox[rgb]{1.00,0.00,0.00}{1,1,1}{\strut ##1}}}
\expandafter\def\csname PY@tok@kc\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kd\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kn\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@kr\endcsname{\let\PY@bf=\textbf\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@bp\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.50,0.00}{##1}}}
\expandafter\def\csname PY@tok@fm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.00,0.00,1.00}{##1}}}
\expandafter\def\csname PY@tok@vc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vg\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@vm\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.10,0.09,0.49}{##1}}}
\expandafter\def\csname PY@tok@sa\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sc\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@dl\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s2\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@sh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@s1\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.73,0.13,0.13}{##1}}}
\expandafter\def\csname PY@tok@mb\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mf\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mh\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mi\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@il\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@mo\endcsname{\def\PY@tc##1{\textcolor[rgb]{0.40,0.40,0.40}{##1}}}
\expandafter\def\csname PY@tok@ch\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cm\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cpf\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@c1\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}
\expandafter\def\csname PY@tok@cs\endcsname{\let\PY@it=\textit\def\PY@tc##1{\textcolor[rgb]{0.25,0.50,0.50}{##1}}}

\def\PYZbs{\char`\\}
\def\PYZus{\char`\_}
\def\PYZob{\char`\{}
\def\PYZcb{\char`\}}
\def\PYZca{\char`\^}
\def\PYZam{\char`\&}
\def\PYZlt{\char`\<}
\def\PYZgt{\char`\>}
\def\PYZsh{\char`\#}
\def\PYZpc{\char`\%}
\def\PYZdl{\char`\$}
\def\PYZhy{\char`\-}
\def\PYZsq{\char`\'}
\def\PYZdq{\char`\"}
\def\PYZti{\char`\~}
% for compatibility with earlier versions
\def\PYZat{@}
\def\PYZlb{[}
\def\PYZrb{]}
\makeatother


    % Exact colors from NB
    \definecolor{incolor}{rgb}{0.0, 0.0, 0.5}
    \definecolor{outcolor}{rgb}{0.545, 0.0, 0.0}



    
    % Prevent overflowing lines due to hard-to-break entities
    \sloppy 
    % Setup hyperref package
    \hypersetup{
      breaklinks=true,  % so long urls are correctly broken across lines
      colorlinks=true,
      urlcolor=urlcolor,
      linkcolor=linkcolor,
      citecolor=citecolor,
      }
    % Slightly bigger margins than the latex defaults
    
    \geometry{verbose,tmargin=1in,bmargin=1in,lmargin=1in,rmargin=1in}
    
    

    \begin{document}
    
    
    \maketitle
    
    

    
    \section{Mosaik building blocks}\label{mosaik-building-blocks}

Last edited: July 31 2018 Contributors: Karen Pardos Olsen Made with:
python v3.6.5, pandas v0.23.3 Purpose: A demonstration of how mosaik
works, with a slow build up from a simple one-energy-supply scenario to
a multi-energy one.

    Import mosaik package from Tue as well as some modules for plotting. The
strings "data\_path" and "plot\_path" are used to store temporary files
and plots in subfolders.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}1}]:} \PY{o}{\PYZpc{}}\PY{k}{matplotlib} inline
        \PY{k+kn}{import} \PY{n+nn}{mosaik}
        \PY{k+kn}{import} \PY{n+nn}{mosaik}\PY{n+nn}{.}\PY{n+nn}{util}
        \PY{k+kn}{import} \PY{n+nn}{pandas} \PY{k}{as} \PY{n+nn}{pd}
        \PY{k+kn}{import} \PY{n+nn}{matplotlib} \PY{k}{as} \PY{n+nn}{mpl}
        \PY{k+kn}{import} \PY{n+nn}{matplotlib}\PY{n+nn}{.}\PY{n+nn}{pyplot} \PY{k}{as} \PY{n+nn}{plt}
        \PY{n}{data\PYZus{}path} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{temp\PYZus{}files/}\PY{l+s+s1}{\PYZsq{}}
        \PY{n}{plot\PYZus{}path} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{plots/}\PY{l+s+s1}{\PYZsq{}}
\end{Verbatim}


    Let's look at a house that is supplied with power from the grid and
nothing else. No solar PVs, batteries or other smart devices. Here's a
sketch of that 2-component circuit:

    We will pretend that we have measured the demand for this house over a
24hr timespan and that the house has been supplied with power from the
grid the whole time. As such, mosaik doesn't have to calculate anything,
and the demand will be reflected as negative power provided to the grid
as we will see in the final plot.

Now follows \textbf{5 steps} to create and run a simulation of this
system.

Following that, we will add items (called entities in mosaik) to the
system.

    \subsubsection{1. Define entities}\label{define-entities}

First, we need to tell mosaik what kind of components live inside the
system we want to simulate. In mosaik, these components are called
\textbf{entities} and the system is called \textbf{world}. We create the
entities by building a function that defines them and can add them to
the world. We call this function "init\_entities" because it initializes
the entities that will live in the world. Note that the entities are not
connected to each other yet, that comes in step 4.

In order to create the entities, we have the following information: -
"Demand" is just a timeseries of demand to be read from a file
('signals.h5' in mosaik\_demand.py) - "Grid" just balances power
consumption with supply (mosaik\_grid.py) - "Collector" makes a log of
the data of interest and stores it in HDF5 binary data format.

You will notice, that the function below takes "world" as an argument
and calls "world.start()". This function takes whatever arguments we
pass for each entity and stores them in \textbf{world}. In more correct
terms, start() adds the entities as attributes to the object
\textbf{world} which is itself an instance of the class mosaik.World().
If you're just too curious, you can check out the raw code for
world.start() in scenario.py in the mosaik module.

We also give "filename" as an argument, to tell the "Collector" where to
store the output of the simulation.

Finally, init\_entities() also returns two dictionaries, "sim\_dict" and
"entity\_dict", which can be used to connect the entities later (see
step 4).

By reading the comments inside init\_entities() you can get an idea of
where this information is given to mosaik.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}2}]:} \PY{n}{filename\PYZus{}1} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid\PYZus{}demand\PYZus{}output}\PY{l+s+s1}{\PYZsq{}}
        \PY{k}{def} \PY{n+nf}{init\PYZus{}entities}\PY{p}{(}\PY{n}{world}\PY{p}{,}\PY{n}{filename} \PY{o}{=} \PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}1}\PY{p}{)}\PY{p}{:}
            \PY{n}{sim\PYZus{}dict} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            \PY{n}{entity\PYZus{}dict} \PY{o}{=} \PY{p}{\PYZob{}}\PY{p}{\PYZcb{}}
            
            \PY{c+c1}{\PYZsh{}\PYZsh{} Demand}
            \PY{c+c1}{\PYZsh{} Params:}
            \PY{c+c1}{\PYZsh{}   rated\PYZus{}capacity: Maximal power draw (indicative) [kW]}
            \PY{c+c1}{\PYZsh{} Output:}
            \PY{c+c1}{\PYZsh{}   P: Current power draw [kW]}
            \PY{c+c1}{\PYZsh{} Desc:}
            \PY{c+c1}{\PYZsh{}   Read demand time series from a CSV file (=\PYZgt{} Prel in [0, 1])}
            \PY{c+c1}{\PYZsh{}   P = Pmax * Prel}
        
            \PY{n}{demand\PYZus{}sim} \PY{o}{=} \PY{n}{world}\PY{o}{.}\PY{n}{start}\PY{p}{(}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{DemandSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                    \PY{n}{eid\PYZus{}prefix}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand\PYZus{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                    \PY{n}{step\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
            \PY{n}{demand\PYZus{}entity\PYZus{}1} \PY{o}{=} \PY{n}{demand\PYZus{}sim}\PY{o}{.}\PY{n}{DemandSim}\PY{p}{(}\PY{n}{rated\PYZus{}capacity}\PY{o}{=}\PY{l+m+mi}{4}\PY{p}{,} \PY{n}{seriesname}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/flexhouse\PYZus{}20180218}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
            \PY{n}{sim\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{demand\PYZus{}sim}
            \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{demand\PYZus{}entity\PYZus{}1}
            
            \PY{c+c1}{\PYZsh{}\PYZsh{} Grid model}
            \PY{c+c1}{\PYZsh{} Params:}
            \PY{c+c1}{\PYZsh{}   droop: Relationship between power draw and voltage change [V/kW] (usually \PYZlt{}0)}
            \PY{c+c1}{\PYZsh{}   V0: Base voltage [V]}
            \PY{c+c1}{\PYZsh{} Output:}
            \PY{c+c1}{\PYZsh{}   V: Current voltage at bus [V]}
            \PY{c+c1}{\PYZsh{}   Pgrid: Current power draw from the grid [kW]}
            \PY{c+c1}{\PYZsh{} Input:}
            \PY{c+c1}{\PYZsh{}   P: Current power draw from units (Many connections) [kW]}
            \PY{c+c1}{\PYZsh{} Desc:}
            \PY{c+c1}{\PYZsh{}   Pgrid = \PYZhy{} (P\PYZus{}1 + ... + P\PYZus{}N)}
            \PY{c+c1}{\PYZsh{}   V = V0 + droop * Pgrid}
        
            \PY{n}{grid\PYZus{}sim} \PY{o}{=} \PY{n}{world}\PY{o}{.}\PY{n}{start}\PY{p}{(}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{GridSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                    \PY{n}{eid\PYZus{}prefix}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid\PYZus{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                    \PY{n}{step\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
            \PY{n}{grid\PYZus{}entity\PYZus{}1} \PY{o}{=} \PY{n}{grid\PYZus{}sim}\PY{o}{.}\PY{n}{GridSim}\PY{p}{(}\PY{n}{V0}\PY{o}{=}\PY{l+m+mi}{240}\PY{p}{,} \PY{n}{droop}\PY{o}{=}\PY{l+m+mf}{0.1}\PY{p}{)}
            \PY{n}{sim\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{grid\PYZus{}sim}
            \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{grid\PYZus{}entity\PYZus{}1}
            
            \PY{c+c1}{\PYZsh{}\PYZsh{} Collector}
            \PY{c+c1}{\PYZsh{} Params:}
            \PY{c+c1}{\PYZsh{}   Storefilename: String indicating the storage file to use}
            \PY{c+c1}{\PYZsh{} Input:}
            \PY{c+c1}{\PYZsh{}   GENERIC: Anything can be connected and will be logged}
            \PY{c+c1}{\PYZsh{} Desc:}
            \PY{c+c1}{\PYZsh{}   During simulation, save system state}
            \PY{c+c1}{\PYZsh{}   After simulation, write collected data to disk into the \PYZsq{}datastore\PYZsq{} file with the given name.}
        
            \PY{n}{collector\PYZus{}sim} \PY{o}{=} \PY{n}{world}\PY{o}{.}\PY{n}{start}\PY{p}{(}
                    \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{CollectorSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                    \PY{n}{step\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{60}\PY{p}{,}
                    \PY{n}{save\PYZus{}h5}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,}
                    \PY{n}{h5\PYZus{}storename}\PY{o}{=}\PY{n}{filename}\PY{p}{,}
                    \PY{n}{h5\PYZus{}panelname}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Monitor\PYZus{}SimpleCase\PYZus{}Centralized}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                    \PY{n}{print\PYZus{}results}\PY{o}{=}\PY{k+kc}{False}\PY{p}{)}
            \PY{n}{collector\PYZus{}entity} \PY{o}{=} \PY{n}{collector\PYZus{}sim}\PY{o}{.}\PY{n}{Collector}\PY{p}{(}\PY{p}{)}
            \PY{n}{sim\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{collector\PYZus{}sim}
            \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{collector\PYZus{}entity}
            
            \PY{k}{return} \PY{n}{sim\PYZus{}dict}\PY{p}{,} \PY{n}{entity\PYZus{}dict}
\end{Verbatim}


    \subsubsection{2. List entities in simulation
configuration}\label{list-entities-in-simulation-configuration}

Insert these three entities in the SIM\_CONFIG dictionary which defines
which simulators we can run:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}3}]:} \PY{n}{SIM\PYZus{}CONFIG} \PY{o}{=} \PY{p}{\PYZob{}}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{DemandSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}demand:DemandSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{p}{\PYZcb{}}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{GridSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}grid:GridSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{p}{\PYZcb{}}\PY{p}{,}
            \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{CollectorSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector:Collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
            \PY{p}{\PYZcb{}}\PY{p}{,}
        \PY{p}{\PYZcb{}}
\end{Verbatim}


    \subsubsection{3. Initiate "world"}\label{initiate-world}

Initiate the \textbf{world} object with the configuration given above
and use the init\_entities() function to insert entities into it:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}4}]:} \PY{n}{world} \PY{o}{=} \PY{n}{mosaik}\PY{o}{.}\PY{n}{World}\PY{p}{(}\PY{n}{SIM\PYZus{}CONFIG}\PY{p}{)}
        \PY{n}{sim\PYZus{}dict}\PY{p}{,} \PY{n}{entity\PYZus{}dict} \PY{o}{=} \PY{n}{init\PYZus{}entities}\PY{p}{(}\PY{n}{world}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Starting "DemandSim" as "DemandSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'DemandSim': \{'public': True, 'params': ['seriesname', 'rated\_capacity'], 'attrs': ['P']\}\}\}
Starting "GridSim" as "GridSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'GridSim': \{'public': True, 'params': ['V0', 'droop'], 'attrs': ['P', 'Pgrid', 'V']\}\}\}
Starting "CollectorSim" as "CollectorSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'Collector': \{'public': True, 'any\_inputs': True, 'params': [], 'attrs': []\}\}\}

    \end{Verbatim}

    \subsubsection{4. Connect components}\label{connect-components}

We need to connect the house (demand1) to the grid (grid1), and both the
grid and demand to the collector that will collect data points of power
every second.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}5}]:} \PY{c+c1}{\PYZsh{} Connect units to grid busbar}
        \PY{n}{world}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
        
        \PY{c+c1}{\PYZsh{} Connect to Collector}
        \PY{n}{world}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{DemP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
        \PY{n}{world}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Pgrid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{GridP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \subsubsection{5. Run simulation!}\label{run-simulation}

Set end time and run simulation:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}6}]:} \PY{n}{END} \PY{o}{=} \PY{l+m+mi}{24}\PY{o}{*}\PY{l+m+mi}{60}\PY{o}{*}\PY{l+m+mi}{60}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1} \PY{c+c1}{\PYZsh{} 24 hours, 1 MosaikTime = 1 second}
        \PY{n}{world}\PY{o}{.}\PY{n}{run}\PY{p}{(}\PY{n}{END}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Starting simulation.
Simulation finished successfully.
<class 'pandas.core.panel.Panel'>
Dimensions: 2 (items) x 1440 (major\_axis) x 2 (minor\_axis)
Items axis: DemandSim-0.demand\_\_0 to GridSim-0.grid\_\_0
Major\_axis axis: 0 to 86340
Minor\_axis axis: DemP to GridP
Saved to store: temp\_files/grid\_demand\_output, panel: Monitor\_SimpleCase\_Centralized

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
/home/karen/code/virtualenv/mosaik\_env/lib/python3.6/site-packages/pandas/core/panel.py:277: FutureWarning: Sorting because non-concatenation axis is not aligned. A future version
of pandas will change to not sort by default.

To accept the future behavior, pass 'sort=False'.

To retain the current behavior and silence the warning, pass 'sort=True'.

  d = cls.\_homogenize\_dict(cls, data, intersect=intersect, dtype=dtype)
/home/karen/Projects/ERIGrid/Syslab\_course/notebooks/simple\_mosaik\_intro/scenario\_build\_up/collector.py:70: FutureWarning: 
Panel is deprecated and will be removed in a future version.
The recommended way to represent these types of 3-dimensional data are with a MultiIndex on a DataFrame, via the Panel.to\_frame() method
Alternatively, you can use the xarray package http://xarray.pydata.org/en/stable/.
Pandas provides a `.to\_xarray()` method to help automate this conversion.

  panel = pd.Panel.from\_dict(\{k: pd.DataFrame(v, index=self.time\_list) for k,v in self.data.items()\})

    \end{Verbatim}

    \subsubsection{Plot the result}\label{plot-the-result}

The warning you might see above is due to the "panel" format of storing
data being deprecated soon. So we will save the data in the newer
DataFrame format to avoid getting used to the panel format:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}7}]:} \PY{n}{store} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{HDFStore}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}1}\PY{p}{)}
        \PY{n}{panel} \PY{o}{=} \PY{n}{store}\PY{p}{[}\PY{n}{store}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}
        \PY{n}{store}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)}
        \PY{n}{df} \PY{o}{=} \PY{n}{panel}\PY{o}{.}\PY{n}{swapaxes}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{.}\PY{n}{to\PYZus{}frame}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{T}
        \PY{n}{df}\PY{o}{.}\PY{n}{to\PYZus{}pickle}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}1}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZus{}df}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/home/karen/code/virtualenv/mosaik\_env/lib/python3.6/site-packages/pandas/io/pytables.py:1375: FutureWarning: 
Panel is deprecated and will be removed in a future version.
The recommended way to represent these types of 3-dimensional data are with a MultiIndex on a DataFrame, via the Panel.to\_frame() method
Alternatively, you can use the xarray package http://xarray.pydata.org/en/stable/.
Pandas provides a `.to\_xarray()` method to help automate this conversion.

  return s.read(**kwargs)
/home/karen/code/virtualenv/mosaik\_env/lib/python3.6/site-packages/ipykernel\_launcher.py:4: FutureWarning: 
Panel is deprecated and will be removed in a future version.
The recommended way to represent these types of 3-dimensional data are with a MultiIndex on a DataFrame, via the Panel.to\_frame() method
Alternatively, you can use the xarray package http://xarray.pydata.org/en/stable/.
Pandas provides a `.to\_xarray()` method to help automate this conversion.

  after removing the cwd from sys.path.

    \end{Verbatim}

    Read dataframe and convert time from seconds to hours:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}8}]:} \PY{n}{df} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{read\PYZus{}pickle}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}1}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZus{}df}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{df}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{df}\PY{o}{.}\PY{n}{index}\PY{o}{.}\PY{n}{values}\PY{o}{/}\PY{l+m+mi}{60}\PY{o}{/}\PY{l+m+mf}{60.}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}9}]:} \PY{n}{mpl}\PY{o}{.}\PY{n}{rcParams}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font.size}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{=}\PY{l+m+mi}{10}
        \PY{n}{ax1} \PY{o}{=} \PY{n}{df}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{x}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{15}\PY{p}{,}\PY{l+m+mi}{7}\PY{p}{)}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Time [hrs]}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Power [W]}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
        \PY{n}{plt}\PY{o}{.}\PY{n}{savefig}\PY{p}{(}\PY{n}{plot\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}1}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_19_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    The power consumed by the house (shown as negative power production in
blue), is exactly balanced by the positive power supplied by the grid
(in orange).

    \subsection{Adding a PV installation (or
two)}\label{adding-a-pv-installation-or-two}

    Now let's add a couple of solar panels (PVs) to the house, converting
the consumer into a prosumer. Here's a sketch of that 4-component
circuit:

Again, we go through the same 5 steps, creating a new and slightly more
complex world.

    \subsubsection{1. Define entities}\label{define-entities}

We will create a new world, but build upon work done above by adding
entities to the group of entities already initiated. For the PVs we will
use a file of solar radiation data combined with a rated capacity of
each PV (maximum output in kW, set here to be different for the two to
tell them apart on plots).

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}10}]:} \PY{k}{def} \PY{n+nf}{add\PYZus{}entities\PYZus{}1}\PY{p}{(}\PY{n}{world}\PY{p}{,}\PY{n}{sim\PYZus{}dict}\PY{p}{,}\PY{n}{entity\PYZus{}dict}\PY{p}{)}\PY{p}{:}
             
             \PY{c+c1}{\PYZsh{}\PYZsh{} Photovoltaic Producer}
             \PY{c+c1}{\PYZsh{} Params:}
             \PY{c+c1}{\PYZsh{}   rated\PYZus{}capacity: Rated (maximal) power [kW]}
             \PY{c+c1}{\PYZsh{}   seriesname: Name of series in the data store}
             \PY{c+c1}{\PYZsh{} Output:}
             \PY{c+c1}{\PYZsh{}   P: Current production [kW]}
             \PY{c+c1}{\PYZsh{}   Pav: Current maximally available production [kW]}
             \PY{c+c1}{\PYZsh{}   Pmax: Current power limit [kW]}
             \PY{c+c1}{\PYZsh{} Input:}
             \PY{c+c1}{\PYZsh{}   Plimit: Current power limit [kW]}
             \PY{c+c1}{\PYZsh{} Desc:}
             \PY{c+c1}{\PYZsh{}   Read PV production from a CSV file (=\PYZgt{} Pav)}
             \PY{c+c1}{\PYZsh{}   P = min(Pav, Plimit)}
         
             \PY{n}{pv\PYZus{}sim} \PY{o}{=} \PY{n}{world}\PY{o}{.}\PY{n}{start}\PY{p}{(}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PVSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                     \PY{n}{eid\PYZus{}prefix}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv\PYZus{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                     \PY{n}{step\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{pv\PYZus{}entity\PYZus{}1} \PY{o}{=} \PY{n}{pv\PYZus{}sim}\PY{o}{.}\PY{n}{PVSim}\PY{p}{(}
                     \PY{n}{rated\PYZus{}capacity}\PY{o}{=}\PY{l+m+mi}{4}\PY{p}{,}
                     \PY{n}{series\PYZus{}name}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/PV715\PYZus{}20180510}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{sim\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{pv\PYZus{}sim}
             \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{pv\PYZus{}entity\PYZus{}1}
             
             \PY{n}{pv\PYZus{}sim} \PY{o}{=} \PY{n}{world}\PY{o}{.}\PY{n}{start}\PY{p}{(}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PVSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                     \PY{n}{eid\PYZus{}prefix}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv\PYZus{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                     \PY{n}{step\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{pv\PYZus{}entity\PYZus{}2} \PY{o}{=} \PY{n}{pv\PYZus{}sim}\PY{o}{.}\PY{n}{PVSim}\PY{p}{(}
                     \PY{n}{rated\PYZus{}capacity}\PY{o}{=}\PY{l+m+mi}{3}\PY{p}{,}
                     \PY{n}{series\PYZus{}name}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{/PV715\PYZus{}20180510}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
             \PY{n}{sim\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{pv\PYZus{}sim}
             \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{pv\PYZus{}entity\PYZus{}2}
             \PY{k}{return} \PY{n}{sim\PYZus{}dict}\PY{p}{,} \PY{n}{entity\PYZus{}dict}
\end{Verbatim}


    \subsubsection{2. List entities in simulation
configuration}\label{list-entities-in-simulation-configuration}

The new entities have to be listed in the SIM\_CONFIG dictionary:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}11}]:} \PY{n}{SIM\PYZus{}CONFIG} \PY{o}{=} \PY{p}{\PYZob{}}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{DemandSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}demand:DemandSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{GridSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}grid:GridSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{CollectorSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector:Collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PVSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}pv:PVSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
         \PY{p}{\PYZcb{}}
\end{Verbatim}


    \subsubsection{3. Initiate "world"}\label{initiate-world}

Now we initiate a new world (world\_2) the same way as before, but
adding the extra entity corresponding to PV and making sure to save the
output from the collector in a different file
(datastore\_grid\_demand\_PV):

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}12}]:} \PY{n}{world\PYZus{}2} \PY{o}{=} \PY{n}{mosaik}\PY{o}{.}\PY{n}{World}\PY{p}{(}\PY{n}{SIM\PYZus{}CONFIG}\PY{p}{)}
         \PY{n}{filename\PYZus{}2} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid\PYZus{}demand\PYZus{}PV\PYZus{}output}\PY{l+s+s1}{\PYZsq{}}
         \PY{n}{sim\PYZus{}dict}\PY{p}{,} \PY{n}{entity\PYZus{}dict} \PY{o}{=} \PY{n}{init\PYZus{}entities}\PY{p}{(}\PY{n}{world\PYZus{}2}\PY{p}{,}\PY{n}{filename}\PY{o}{=}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}2}\PY{p}{)}
         \PY{n}{sim\PYZus{}dict}\PY{p}{,} \PY{n}{entity\PYZus{}dict} \PY{o}{=} \PY{n}{add\PYZus{}entities\PYZus{}1}\PY{p}{(}\PY{n}{world\PYZus{}2}\PY{p}{,}\PY{n}{sim\PYZus{}dict}\PY{p}{,}\PY{n}{entity\PYZus{}dict}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Starting "DemandSim" as "DemandSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'DemandSim': \{'public': True, 'params': ['seriesname', 'rated\_capacity'], 'attrs': ['P']\}\}\}
Starting "GridSim" as "GridSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'GridSim': \{'public': True, 'params': ['V0', 'droop'], 'attrs': ['P', 'Pgrid', 'V']\}\}\}
Starting "CollectorSim" as "CollectorSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'Collector': \{'public': True, 'any\_inputs': True, 'params': [], 'attrs': []\}\}\}
Starting "PVSim" as "PVSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'PVSim': \{'public': True, 'params': ['series\_name', 'rated\_capacity'], 'attrs': ['P', 'Pav', 'Pmax']\}\}\}
Starting "PVSim" as "PVSim-1" {\ldots}
\{'api\_version': '2.3', 'models': \{'PVSim': \{'public': True, 'params': ['series\_name', 'rated\_capacity'], 'attrs': ['P', 'Pav', 'Pmax']\}\}\}

    \end{Verbatim}

    \subsubsection{4. Connect components}\label{connect-components}

The PVs are connected to the grid (grid1) and solar power data is
collected by the collector:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}13}]:} \PY{c+c1}{\PYZsh{} Connect units to grid busbar}
         \PY{n}{world\PYZus{}2}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}2}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}2}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Connect to Collector}
         \PY{n}{world\PYZus{}2}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{DemP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}2}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Pgrid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{GridP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}2}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{SolarP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}2}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{SolarP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \subsubsection{5. Run simulation!}\label{run-simulation}

Set end time and run simulation:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}14}]:} \PY{n}{END} \PY{o}{=} \PY{l+m+mi}{24}\PY{o}{*}\PY{l+m+mi}{60}\PY{o}{*}\PY{l+m+mi}{60}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1} \PY{c+c1}{\PYZsh{} 24 hours, 1 MosaikTime = 1 second}
         \PY{n}{world\PYZus{}2}\PY{o}{.}\PY{n}{run}\PY{p}{(}\PY{n}{END}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Starting simulation.
Simulation finished successfully.
<class 'pandas.core.panel.Panel'>
Dimensions: 4 (items) x 1440 (major\_axis) x 3 (minor\_axis)
Items axis: DemandSim-0.demand\_\_0 to PVSim-1.pv\_\_0
Major\_axis axis: 0 to 86340
Minor\_axis axis: DemP to SolarP
Saved to store: temp\_files/grid\_demand\_PV\_output, panel: Monitor\_SimpleCase\_Centralized

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
/home/karen/code/virtualenv/mosaik\_env/lib/python3.6/site-packages/pandas/core/panel.py:277: FutureWarning: Sorting because non-concatenation axis is not aligned. A future version
of pandas will change to not sort by default.

To accept the future behavior, pass 'sort=False'.

To retain the current behavior and silence the warning, pass 'sort=True'.

  d = cls.\_homogenize\_dict(cls, data, intersect=intersect, dtype=dtype)
/home/karen/Projects/ERIGrid/Syslab\_course/notebooks/simple\_mosaik\_intro/scenario\_build\_up/collector.py:70: FutureWarning: 
Panel is deprecated and will be removed in a future version.
The recommended way to represent these types of 3-dimensional data are with a MultiIndex on a DataFrame, via the Panel.to\_frame() method
Alternatively, you can use the xarray package http://xarray.pydata.org/en/stable/.
Pandas provides a `.to\_xarray()` method to help automate this conversion.

  panel = pd.Panel.from\_dict(\{k: pd.DataFrame(v, index=self.time\_list) for k,v in self.data.items()\})

    \end{Verbatim}

    \subsubsection{Plot the result}\label{plot-the-result}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}15}]:} \PY{n}{store} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{HDFStore}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}2}\PY{p}{)}
         \PY{n}{panel} \PY{o}{=} \PY{n}{store}\PY{p}{[}\PY{n}{store}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}
         \PY{n}{store}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)}
         \PY{n}{df} \PY{o}{=} \PY{n}{panel}\PY{o}{.}\PY{n}{swapaxes}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{.}\PY{n}{to\PYZus{}frame}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{T}
         \PY{n}{df}\PY{o}{.}\PY{n}{to\PYZus{}pickle}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}2}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZus{}df}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{df} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{read\PYZus{}pickle}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}2}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZus{}df}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{df}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{df}\PY{o}{.}\PY{n}{index}\PY{o}{.}\PY{n}{values}\PY{o}{/}\PY{l+m+mi}{60}\PY{o}{/}\PY{l+m+mf}{60.}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/home/karen/code/virtualenv/mosaik\_env/lib/python3.6/site-packages/pandas/io/pytables.py:1375: FutureWarning: 
Panel is deprecated and will be removed in a future version.
The recommended way to represent these types of 3-dimensional data are with a MultiIndex on a DataFrame, via the Panel.to\_frame() method
Alternatively, you can use the xarray package http://xarray.pydata.org/en/stable/.
Pandas provides a `.to\_xarray()` method to help automate this conversion.

  return s.read(**kwargs)
/home/karen/code/virtualenv/mosaik\_env/lib/python3.6/site-packages/ipykernel\_launcher.py:4: FutureWarning: 
Panel is deprecated and will be removed in a future version.
The recommended way to represent these types of 3-dimensional data are with a MultiIndex on a DataFrame, via the Panel.to\_frame() method
Alternatively, you can use the xarray package http://xarray.pydata.org/en/stable/.
Pandas provides a `.to\_xarray()` method to help automate this conversion.

  after removing the cwd from sys.path.

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}16}]:} \PY{n}{mpl}\PY{o}{.}\PY{n}{rcParams}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font.size}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{=}\PY{l+m+mi}{10}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{df}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{x}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{15}\PY{p}{,}\PY{l+m+mi}{7}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Time [hrs]}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Power [W]}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{savefig}\PY{p}{(}\PY{n}{plot\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}2}\PY{p}{)}
\end{Verbatim}


    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_35_0.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    In the beginning of the day, power consumed by the house (shown as
negative power production in blue), is again balanced by the positive
power supplied by the grid (in orange).

But during the hours of the day with sunlight (8 AM - 4 PM roughly), the
PVs are producing more power than what is consumed by the house, and it
has to dump the surplus of energy onto the grid. Therefore, the power
supplied by the grid goes from mirroring the demand, to becoming
negative at times when the PVs are producing the most power.

    \subsection{Adding a battery (and some
controllers)}\label{adding-a-battery-and-some-controllers}

In Denmark, any surplus in energy production from PVs (as in the example
above) can be returned to the grid, but with no monetary gain for the
prosumer. That is, rsted will not pay you for the extra electricity
that you send back to the grid. Thus, it becomes advantageous for the
prosumer to store this surplus in energy for later, say, when the Sun
has gone down.

That's a common HEMS scenario, which can be sketched like this:

Again, we go through the same 5 steps.

    \subsubsection{1. Define entities}\label{define-entities}

Again, we will create a new world (world \#3) , by adding entities to
the group of entities in the previous example. For the battery, we will
use the battery model which can be found in my\_batt\_sim.py. Given the
"charge change rate", this model can update the current State of Charge
and draws a new limit on what power can be charged/discharged at any
time step.

There's an extra complecation here, since we only wish to charge the
battery when there is a surplus of power generated from the PVs. In
order to for the system to make this decision automatically, we add a
controller (control\_entity\_1) as a separate entity. The controller
checks in any time step whether there is a positive power supplied from
the grid, and if so, connect the battery so that it may charge. When
needed, the controller can start discharging the battery instead of usin
power from the grid.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}17}]:} \PY{k}{def} \PY{n+nf}{add\PYZus{}entities\PYZus{}2}\PY{p}{(}\PY{n}{world}\PY{p}{,}\PY{n}{sim\PYZus{}dict}\PY{p}{,}\PY{n}{entity\PYZus{}dict}\PY{p}{)}\PY{p}{:}
             
             \PY{c+c1}{\PYZsh{}\PYZsh{} Battery}
             \PY{c+c1}{\PYZsh{} Params:}
             \PY{c+c1}{\PYZsh{}   rated\PYZus{}charge\PYZus{}capacity: Maximum charge power (\PYZgt{}0) [kW]}
             \PY{c+c1}{\PYZsh{}   rated\PYZus{}discharge\PYZus{}capacity: Maximum discharge power (\PYZgt{}0) [kW]}
             \PY{c+c1}{\PYZsh{}   rated\PYZus{}capacity: Maximal state of charge (\PYZgt{}0) [kWs]}
             \PY{c+c1}{\PYZsh{}   initial\PYZus{}charge\PYZus{}rel: Battery fill \PYZpc{} at start (in [0,1]) [r.u.]}
             \PY{c+c1}{\PYZsh{}   charge\PYZus{}change\PYZus{}rate: Time\PYZhy{}delay factor (in [0,1], 1 =\PYZgt{} instant response)}
             \PY{c+c1}{\PYZsh{}   dt: Conversion factor for one time step (default: 1.0/(60*60) = 1sec/time step)}
             \PY{c+c1}{\PYZsh{} Output:}
             \PY{c+c1}{\PYZsh{}   P: Current production/consumption [kW]}
             \PY{c+c1}{\PYZsh{}   SoC: Current state\PYZhy{}of\PYZhy{}charge (in [0, SoCmax]) [kWs]}
             \PY{c+c1}{\PYZsh{} Input:}
             \PY{c+c1}{\PYZsh{}   Pset: Current power target [kW]}
             \PY{c+c1}{\PYZsh{} Desc:}
             \PY{c+c1}{\PYZsh{}   P\PYZgt{}0 =\PYZgt{} the battery is outputting power into the grid (discharging)}
             \PY{c+c1}{\PYZsh{}   Pset = Pset bounded to [\PYZhy{}Pmax, Pmax]}
             \PY{c+c1}{\PYZsh{}   P(t) = kappa*Pset + (1\PYZhy{}kappa)*P(t\PYZhy{}1) bounded to [\PYZhy{}SoC, SoCmax\PYZhy{}SoC]}
             \PY{c+c1}{\PYZsh{}   SoC(t) = SoC(t\PYZhy{}1) + P(t) bounded to [0, SoCmax]}
         
             \PY{n}{batt\PYZus{}sim} \PY{o}{=} \PY{n}{world}\PY{o}{.}\PY{n}{start}\PY{p}{(}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{BatterySim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                     \PY{n}{eid\PYZus{}prefix}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{batt\PYZus{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                     \PY{n}{step\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{batt\PYZus{}entity\PYZus{}1} \PY{o}{=} \PY{n}{batt\PYZus{}sim}\PY{o}{.}\PY{n}{BatterySim}\PY{p}{(}
                     \PY{n}{rated\PYZus{}capacity}\PY{o}{=}\PY{l+m+mi}{10}\PY{p}{,}
                     \PY{n}{rated\PYZus{}discharge\PYZus{}capacity}\PY{o}{=}\PY{l+m+mi}{30}\PY{p}{,}
                     \PY{n}{rated\PYZus{}charge\PYZus{}capacity}\PY{o}{=}\PY{l+m+mi}{30}\PY{p}{,}
                     \PY{n}{initial\PYZus{}charge\PYZus{}rel}\PY{o}{=}\PY{l+m+mf}{0.5}\PY{p}{,}
                     \PY{n}{charge\PYZus{}change\PYZus{}rate}\PY{o}{=}\PY{l+m+mf}{0.03}\PY{p}{,}
                     \PY{p}{)}
             \PY{n}{sim\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{batt}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{batt\PYZus{}sim}
             \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{batt1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{batt\PYZus{}entity\PYZus{}1}
             
             \PY{c+c1}{\PYZsh{}\PYZsh{} Controller}
             \PY{c+c1}{\PYZsh{} Params:}
             \PY{c+c1}{\PYZsh{}   kappa: Time\PYZhy{}delay compensation factor (usually in [0, 1], 1 =\PYZgt{} instant response) [a.u.]}
             \PY{c+c1}{\PYZsh{} Input:}
             \PY{c+c1}{\PYZsh{}   Pgrid: Current power draw [kW]}
             \PY{c+c1}{\PYZsh{}   SoC: Battery state\PYZhy{}of\PYZhy{}charge [kWs]}
             \PY{c+c1}{\PYZsh{} Output:}
             \PY{c+c1}{\PYZsh{}   Pset: Battery power setpoint [kW]}
             \PY{c+c1}{\PYZsh{} Desc:}
             \PY{c+c1}{\PYZsh{}   Psett(t) = kappa * Pgrid + (1 \PYZhy{} kappa) * Psett(t\PYZhy{}1)}
             
             \PY{n}{control\PYZus{}sim} \PY{o}{=} \PY{n}{world}\PY{o}{.}\PY{n}{start}\PY{p}{(}
                     \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ControlSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                     \PY{n}{eid\PYZus{}prefix}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand\PYZus{}}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
                     \PY{n}{step\PYZus{}size}\PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
             \PY{n}{control\PYZus{}entity\PYZus{}1} \PY{o}{=} \PY{n}{control\PYZus{}sim}\PY{o}{.}\PY{n}{ControlSim}\PY{p}{(}\PY{n}{setpoint\PYZus{}change\PYZus{}rate}\PY{o}{=}\PY{l+m+mf}{0.50}\PY{p}{)}
             
             \PY{n}{sim\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{control}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{control\PYZus{}sim}
             \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{control1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{control\PYZus{}entity\PYZus{}1}
             
             \PY{k}{return} \PY{n}{sim\PYZus{}dict}\PY{p}{,} \PY{n}{entity\PYZus{}dict}
\end{Verbatim}


    \subsubsection{2. List entities in simulation
configuration}\label{list-entities-in-simulation-configuration}

The new entities have to be listed in the SIM\_CONFIG dictionary:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}18}]:} \PY{n}{SIM\PYZus{}CONFIG} \PY{o}{=} \PY{p}{\PYZob{}}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{DemandSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}demand:DemandSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{GridSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}grid:GridSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{CollectorSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector:Collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{PVSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}pv:PVSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{BatterySim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}battery:BatterySim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
             \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{ControlSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{p}{\PYZob{}}
                 \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{python}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{mosaik\PYZus{}control:ControlSim}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}
             \PY{p}{\PYZcb{}}\PY{p}{,}
         \PY{p}{\PYZcb{}}
\end{Verbatim}


    \subsubsection{3. Initiate "world"}\label{initiate-world}

Now we initiate a new world (world\_3) the same way as before, but
adding the extra entity corresponding to a battery and making sure to
save the output from the collector in a different file
(datastore\_grid\_demand\_PV\_batt):

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}19}]:} \PY{n}{world\PYZus{}3} \PY{o}{=} \PY{n}{mosaik}\PY{o}{.}\PY{n}{World}\PY{p}{(}\PY{n}{SIM\PYZus{}CONFIG}\PY{p}{)}
         \PY{n}{filename\PYZus{}3} \PY{o}{=} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid\PYZus{}demand\PYZus{}PV\PYZus{}batt\PYZus{}output}\PY{l+s+s1}{\PYZsq{}}
         \PY{n}{sim\PYZus{}dict}\PY{p}{,} \PY{n}{entity\PYZus{}dict} \PY{o}{=} \PY{n}{init\PYZus{}entities}\PY{p}{(}\PY{n}{world\PYZus{}3}\PY{p}{,}\PY{n}{filename}\PY{o}{=}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}3}\PY{p}{)}
         \PY{n}{sim\PYZus{}dict}\PY{p}{,} \PY{n}{entity\PYZus{}dict} \PY{o}{=} \PY{n}{add\PYZus{}entities\PYZus{}1}\PY{p}{(}\PY{n}{world\PYZus{}3}\PY{p}{,}\PY{n}{sim\PYZus{}dict}\PY{p}{,}\PY{n}{entity\PYZus{}dict}\PY{p}{)}
         \PY{n}{sim\PYZus{}dict}\PY{p}{,} \PY{n}{entity\PYZus{}dict} \PY{o}{=} \PY{n}{add\PYZus{}entities\PYZus{}2}\PY{p}{(}\PY{n}{world\PYZus{}3}\PY{p}{,}\PY{n}{sim\PYZus{}dict}\PY{p}{,}\PY{n}{entity\PYZus{}dict}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Starting "DemandSim" as "DemandSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'DemandSim': \{'public': True, 'params': ['seriesname', 'rated\_capacity'], 'attrs': ['P']\}\}\}
Starting "GridSim" as "GridSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'GridSim': \{'public': True, 'params': ['V0', 'droop'], 'attrs': ['P', 'Pgrid', 'V']\}\}\}
Starting "CollectorSim" as "CollectorSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'Collector': \{'public': True, 'any\_inputs': True, 'params': [], 'attrs': []\}\}\}
Starting "PVSim" as "PVSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'PVSim': \{'public': True, 'params': ['series\_name', 'rated\_capacity'], 'attrs': ['P', 'Pav', 'Pmax']\}\}\}
Starting "PVSim" as "PVSim-1" {\ldots}
\{'api\_version': '2.3', 'models': \{'PVSim': \{'public': True, 'params': ['series\_name', 'rated\_capacity'], 'attrs': ['P', 'Pav', 'Pmax']\}\}\}
Starting "BatterySim" as "BatterySim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'BatterySim': \{'public': True, 'params': ['rated\_capacity', 'rated\_charge\_capacity', 'rated\_discharge\_capacity', 'roundtrip\_efficiency', 'initial\_charge\_rel', 'charge\_change\_rate'], 'attrs': ['P', 'Pset', 'SoC', 'relSoC']\}\}\}
Starting "ControlSim" as "ControlSim-0" {\ldots}
\{'api\_version': '2.3', 'models': \{'ControlSim': \{'public': True, 'params': ['setpoint\_change\_rate'], 'attrs': ['Pgrid', 'Pset', 'relSoC']\}\}\}

    \end{Verbatim}

    \subsubsection{4. Connect components}\label{connect-components}

The controller is connected to the grid and to the battery. The keyword
argument "time\_shifted" is added in order to have a loop in the
network, something that is otherwise not allowed in mosaik.

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}20}]:} \PY{c+c1}{\PYZsh{} Connect units to grid busbar}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{batt1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Connect to Collector}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{demand1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{DemP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Pgrid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{GridP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{SolarP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{pv2}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{SolarP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{batt1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{P}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{BattP}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{batt1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{collector}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{SoC}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{BattSoC}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         
         \PY{c+c1}{\PYZsh{} Connect controller}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{grid1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{control1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Pgrid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Pgrid}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{control1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{batt1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Pset}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Pset}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{,} \PY{n}{time\PYZus{}shifted}\PY{o}{=}\PY{k+kc}{True}\PY{p}{,} \PY{n}{initial}\PY{o}{=}\PY{p}{\PYZob{}}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Pset}\PY{l+s+s1}{\PYZsq{}}\PY{p}{:} \PY{l+m+mf}{0.0}\PY{p}{\PYZcb{}}\PY{p}{)}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{connect}\PY{p}{(}\PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{batt1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{n}{entity\PYZus{}dict}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{control1}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{p}{,} \PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relSoC}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{relSoC}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}\PY{p}{)}
\end{Verbatim}


    \subsubsection{5. Run simulation!}\label{run-simulation}

Set end time and run simulation:

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}21}]:} \PY{n}{END} \PY{o}{=} \PY{l+m+mi}{24}\PY{o}{*}\PY{l+m+mi}{60}\PY{o}{*}\PY{l+m+mi}{60}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1} \PY{c+c1}{\PYZsh{} 24 hours, 1 MosaikTime = 1 second}
         \PY{n}{world\PYZus{}3}\PY{o}{.}\PY{n}{run}\PY{p}{(}\PY{n}{END}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
Starting simulation.
Simulation finished successfully.
<class 'pandas.core.panel.Panel'>
Dimensions: 5 (items) x 1440 (major\_axis) x 5 (minor\_axis)
Items axis: BatterySim-0.batt\_\_0 to PVSim-1.pv\_\_0
Major\_axis axis: 0 to 86340
Minor\_axis axis: BattP to SolarP
Saved to store: temp\_files/grid\_demand\_PV\_batt\_output, panel: Monitor\_SimpleCase\_Centralized

    \end{Verbatim}

    \begin{Verbatim}[commandchars=\\\{\}]
/home/karen/code/virtualenv/mosaik\_env/lib/python3.6/site-packages/pandas/core/panel.py:277: FutureWarning: Sorting because non-concatenation axis is not aligned. A future version
of pandas will change to not sort by default.

To accept the future behavior, pass 'sort=False'.

To retain the current behavior and silence the warning, pass 'sort=True'.

  d = cls.\_homogenize\_dict(cls, data, intersect=intersect, dtype=dtype)
/home/karen/Projects/ERIGrid/Syslab\_course/notebooks/simple\_mosaik\_intro/scenario\_build\_up/collector.py:70: FutureWarning: 
Panel is deprecated and will be removed in a future version.
The recommended way to represent these types of 3-dimensional data are with a MultiIndex on a DataFrame, via the Panel.to\_frame() method
Alternatively, you can use the xarray package http://xarray.pydata.org/en/stable/.
Pandas provides a `.to\_xarray()` method to help automate this conversion.

  panel = pd.Panel.from\_dict(\{k: pd.DataFrame(v, index=self.time\_list) for k,v in self.data.items()\})

    \end{Verbatim}

    \subsubsection{Plot the result}\label{plot-the-result}

    \begin{Verbatim}[commandchars=\\\{\}]
{\color{incolor}In [{\color{incolor}22}]:} \PY{n}{store} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{HDFStore}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}3}\PY{p}{)}
         \PY{n}{panel} \PY{o}{=} \PY{n}{store}\PY{p}{[}\PY{n}{store}\PY{o}{.}\PY{n}{keys}\PY{p}{(}\PY{p}{)}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{]}
         \PY{n}{store}\PY{o}{.}\PY{n}{close}\PY{p}{(}\PY{p}{)}
         \PY{n}{df} \PY{o}{=} \PY{n}{panel}\PY{o}{.}\PY{n}{swapaxes}\PY{p}{(}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{o}{.}\PY{n}{to\PYZus{}frame}\PY{p}{(}\PY{p}{)}\PY{o}{.}\PY{n}{T}
         \PY{n}{df}\PY{o}{.}\PY{n}{to\PYZus{}pickle}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}3}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZus{}df}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{df} \PY{o}{=} \PY{n}{pd}\PY{o}{.}\PY{n}{read\PYZus{}pickle}\PY{p}{(}\PY{n}{data\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}3}\PY{o}{+}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{\PYZus{}df}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{df}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]} \PY{o}{=} \PY{n}{df}\PY{o}{.}\PY{n}{index}\PY{o}{.}\PY{n}{values}\PY{o}{/}\PY{l+m+mi}{60}\PY{o}{/}\PY{l+m+mf}{60.}
         \PY{n}{mpl}\PY{o}{.}\PY{n}{rcParams}\PY{p}{[}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{font.size}\PY{l+s+s1}{\PYZsq{}}\PY{p}{]}\PY{o}{=}\PY{l+m+mi}{10}
         \PY{n}{ax1} \PY{o}{=} \PY{n}{df}\PY{o}{.}\PY{n}{plot}\PY{p}{(}\PY{n}{x}\PY{o}{=}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{time}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,}\PY{n}{figsize}\PY{o}{=}\PY{p}{(}\PY{l+m+mi}{15}\PY{p}{,}\PY{l+m+mi}{7}\PY{p}{)}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}xlabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Time [hrs]}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{ax1}\PY{o}{.}\PY{n}{set\PYZus{}ylabel}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{Power [W]}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)}
         \PY{n}{plt}\PY{o}{.}\PY{n}{savefig}\PY{p}{(}\PY{n}{plot\PYZus{}path}\PY{o}{+}\PY{n}{filename\PYZus{}3}\PY{p}{)}
\end{Verbatim}


    \begin{Verbatim}[commandchars=\\\{\}]
/home/karen/code/virtualenv/mosaik\_env/lib/python3.6/site-packages/pandas/io/pytables.py:1375: FutureWarning: 
Panel is deprecated and will be removed in a future version.
The recommended way to represent these types of 3-dimensional data are with a MultiIndex on a DataFrame, via the Panel.to\_frame() method
Alternatively, you can use the xarray package http://xarray.pydata.org/en/stable/.
Pandas provides a `.to\_xarray()` method to help automate this conversion.

  return s.read(**kwargs)
/home/karen/code/virtualenv/mosaik\_env/lib/python3.6/site-packages/ipykernel\_launcher.py:4: FutureWarning: 
Panel is deprecated and will be removed in a future version.
The recommended way to represent these types of 3-dimensional data are with a MultiIndex on a DataFrame, via the Panel.to\_frame() method
Alternatively, you can use the xarray package http://xarray.pydata.org/en/stable/.
Pandas provides a `.to\_xarray()` method to help automate this conversion.

  after removing the cwd from sys.path.

    \end{Verbatim}

    \begin{center}
    \adjustimage{max size={0.9\linewidth}{0.9\paperheight}}{output_49_1.png}
    \end{center}
    { \hspace*{\fill} \\}
    
    Now, we are storing some of the power from the PVs in the battery
instead of sending it back to the grid. After around 10 AM, the battery
is saturated and the extra energy from the PVs cannot be stored
anywhere. However, on a more Danish (i.e. cloudy) day, this would not be
such a big problem.


    % Add a bibliography block to the postdoc
    
    
    
    \end{document}
